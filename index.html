<html>
<head>

<!-- JQuery -->
<script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
<script src="http://code.jquery.com/jquery-migrate-1.2.1.min.js"></script>

<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/aes.js"></script>
<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/rabbit.js"></script>
<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/md5.js"></script>

<!-- Bootstrap -->
<link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css" rel="stylesheet">
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>

<script>
	function randomInt(min, max) { return Math.floor(Math.random() * (max - min)) + min; }
	function modExp(base, exponent, mod) {
		var answer = 1;
		for(var i = 0; i < exponent; ++i) {
			answer = (answer * base) % mod;
		}
		return answer;
	}

	var AESCipher = {
		encrypt : function(message, key) {
			return CryptoJS.AES.encrypt(message, "" + key);
		},
		decrypt : function(encrypted, key) {
			return CryptoJS.enc.Utf8.stringify(CryptoJS.AES.decrypt(encrypted, "" + key));
		}
	};

	var SubstitutionCipher = {
		encrypt : function(message, key) {
			var encrypted = "";
			for(var i = 0; i < message.length; ++i) {
				var shift = CryptoJS.MD5("" + (i + key)).words[0];

				var index = valid_characters.indexOf(message[i]) + shift;
				while(index < 0) index += valid_characters.length;
				index %= valid_characters.length

				encrypted += valid_characters[index];
			}
			return encrypted;
		},
		decrypt : function(encrypted, key) {
			var message = "";
			for(var i = 0; i < encrypted.length; ++i) {
				var shift = CryptoJS.MD5("" + (i + key)).words[0];

				var index = valid_characters.indexOf(encrypted[i]) - shift;
				while(index < 0) index += valid_characters.length;
				index %= valid_characters.length

				message += valid_characters[index ];
			}
			return message;
		}
	};

	var cipher = SubstitutionCipher;

    var DHE_PRIME = 983; // Should be a safe prime
    var DHE_BASE = 5;

    var MY_SECRET = randomInt(0, 100);
    var MY_PUBLIC_KEY = modExp(DHE_BASE, MY_SECRET, DHE_PRIME);

    var THEIR_PUBLIC_KEY;
    var SHARED_SECRET;

    var alphabet = "abcdefghijklmnopqrstuvwxyz";
    var valid_characters = "-()0123456789" + alphabet;

    $(function() {
    	$('#publickey').html(MY_PUBLIC_KEY);
    	$('#start').click(function() {
    		THEIR_PUBLIC_KEY = parseInt($('#theirkey').val());
    		SHARED_SECRET = modExp(THEIR_PUBLIC_KEY, MY_SECRET, DHE_PRIME);
    		$('#shared').html(SHARED_SECRET);
    		$("#keyenter").fadeOut();
    		$('#communicate').fadeIn();
    	});

    	$('#encrypt').click(function() {
    		var message = $('#ein').val();
    		var encrypted = cipher.encrypt(message, SHARED_SECRET);
    		$('#eout').html($('#eout').html() + "<br>" + message + " => " + encrypted);
    		$('#ein').val("");
    	});

    	$('#decrypt').click(function() {
    		var encrypted = $('#din').val();
    		var message = cipher.decrypt(encrypted, SHARED_SECRET);
    		$('#dout').html($('#dout').html() + "<br>" + encrypted + " => " + message);
    		$('#din').val("");
    	});
    })
</script>

<style>

body {
	margin:0;
	background-color:C83BA9;
}

</style>

</head>

<body>

Your Public Key: <div id="publickey"></div>

<div id="keyenter">
Their Public Key: <input id="theirkey"></input>
<button id="start">Start Communicating</button>
</div>

<div id="communicate" hidden>
Shared Secret: <div id='shared'></div>
<div class="row">
	<div class="col-sm-6">
		Encrypt A Message:
		<div id='eout' class="well"></div>
		<input id='ein'></input><button id="encrypt">Encrypt</button>
	</div>
	<div class="col-sm-6">
		Decrypt A Message:
		<div id='dout' class="well"></div>
		<input id='din'></input><button id="decrypt">Decrypt</button>
	</div>
</div>
</div>


</body>

</html>